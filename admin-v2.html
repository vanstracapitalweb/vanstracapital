<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Vanstra Bank</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg: #0f1724;
            --panel: #0b1220;
            --muted: #94a3b8;
            --accent: #e09b3d;
            --card: #0b1228;
            --glass: rgba(255,255,255,0.04);
            --success: #10b981;
            --danger: #ef4444;
        }

        *{box-sizing:border-box}
        body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#d1d5db;background:linear-gradient(180deg,#071029 0%,#041423 100%);}

        /* layout */
        .sidebar{position:fixed;left:0;top:0;bottom:0;width:88px;background:var(--panel);display:flex;flex-direction:column;align-items:center;padding:1rem 0;gap:1rem}
        .brand{display:flex;flex-direction:column;align-items:center;gap:.25rem}
        .brand img{width:40px;height:40px}
        .brand .label{font-weight:700;color:#fff;font-size:12px}

        .nav{display:flex;flex-direction:column;gap:.5rem;width:100%;align-items:center}
        .nav button{width:100%;background:transparent;border:none;color:var(--muted);padding:.6rem;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:12px}
        .nav button.active, .nav button:hover{background:var(--glass);color:#fff}

        .main-content{margin-left:88px;padding:1.25rem 1.5rem;min-height:100vh}
        .topbar{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:1rem}
        .top-left{display:flex;align-items:center;gap:1rem}
        .admin-pill{display:flex;align-items:center;gap:.75rem;padding:.4rem .6rem;border-radius:999px;background:linear-gradient(90deg,var(--card),#07122a);box-shadow:0 4px 20px rgba(0,0,0,0.5)}
        .admin-avatar{width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#071423;font-weight:700}
        .admin-meta{color:var(--muted);font-size:13px}
        .admin-meta .name{color:#fff;font-weight:700}

        .controls{display:flex;align-items:center;gap:.75rem}
        .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:.5rem .75rem;border-radius:10px;color:var(--muted);cursor:pointer}
        .btn.primary{background:var(--accent);color:#071423;border:none}

        /* stats */
        .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1rem}
        .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border-radius:12px;padding:1rem;color:#fff}
        .card .label{font-size:12px;color:var(--muted);margin-bottom:.25rem}
        .card .value{font-weight:800;font-size:1.35rem}

        .layout{display:grid;grid-template-columns:2fr 1fr;gap:1rem}
        .table{width:100%;border-collapse:collapse}
        table th, table td{padding:.7rem;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:13px}
        .user-row{display:flex;gap:.75rem;align-items:center}
        .u-avatar, .user-avatar{width:40px;height:40px;border-radius:8px;background:var(--accent);display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:#071423}
        .muted{color:var(--muted)}

        /* activity */
        .activity-list{display:flex;flex-direction:column;gap:.5rem}
        .activity-item{display:flex;gap:.75rem;align-items:center;padding:.5rem;border-radius:10px;background:rgba(255,255,255,0.02)}

        /* modal */
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center}
        .modal-overlay.active{display:flex}
        .modal-content{background:#071428;border-radius:12px;padding:1.25rem;width:720px;color:#e6eef8}

        /* responsive */
        @media(max-width:1024px){.stats{grid-template-columns:repeat(2,1fr)}.layout{grid-template-columns:1fr}} 
        @media(max-width:640px){.sidebar{display:none}.main-content{margin-left:0;padding:.75rem}.stats{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Sidebar navigation">
        <div class="brand">
            <img src="logo-v.png" alt="Vanstra">
            <div class="label">Vanstra</div>
        </div>

        <nav class="nav" role="navigation">
            <button class="active" data-section="dashboard" onclick="showSection('dashboard')" title="Dashboard">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13h8V3H3v10zM3 21h8v-6H3v6zM13 21h8v-10h-8v10zM13 3v6h8V3h-8z"></path></svg>
            </button>
            <button data-section="users" onclick="showSection('users')" title="Users">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a4 4 0 00-4-4h-1M9 20H4v-2a4 4 0 014-4h1m0-4a4 4 0 110-8 4 4 0 010 8z"></path></svg>
            </button>
            <button data-section="transactions" onclick="showSection('transactions')" title="Transactions">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2"></path></svg>
            </button>
            <div style="flex:1"></div>
            <button data-section="logout" onclick="logout()" title="Logout">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7"></path></svg>
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Admin Header -->
        <div class="topbar">
            <div class="top-left">
                <div class="admin-pill">
                    <div class="admin-avatar" id="adminInitials">A</div>
                    <div class="admin-meta">
                        <div class="name" id="adminName">Administrator</div>
                        <div id="adminEmail" style="font-size:12px;color:var(--muted)">admin@vanstra.bank</div>
                        <div id="adminLoginTime" style="font-size:12px;color:var(--muted)">Logged in now</div>
                    </div>
                </div>
                <div style="color:var(--muted);font-size:14px">Admin Dashboard</div>
            </div>

            <div class="controls">
                <button class="btn" onclick="updateAdminDashboard()" title="Refresh">Refresh</button>
                <div id="syncStatus" class="btn" style="display:flex;align-items:center;gap:.5rem"><span id="syncDot" style="width:8px;height:8px;border-radius:50%;background:var(--success)"></span><span id="lastSyncTime">Synced</span></div>
                <button class="btn primary" onclick="showSection('users')">Manage Users</button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="section active" id="dashboardSection">
            <div class="header">
                <h1 class="header-title">Dashboard Overview</h1>
                <div class="header-actions">
                    <div class="status-badge">
                        <span class="status-dot"></span>
                        <span>System Online</span>
                    </div>
                    <button onclick="updateAdminDashboard()" title="Manually refresh dashboard" style="background: transparent; border: 1px solid #E5E7EB; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; margin-right: 0.5rem;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="opacity: 0.6;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    <div class="sync-status" id="syncStatus">
                        <span class="sync-dot"></span>
                        <span>Synced</span>
                        <span id="lastSyncTime" style="font-size: 11px; opacity: 0.8;">now</span>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-change positive">+0 today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Online Now</div>
                    <div class="stat-value" id="onlineUsers">0</div>
                    <div class="stat-change positive">Active</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Balance</div>
                    <div class="stat-value" id="totalBalance">‚Ç¨0</div>
                    <div class="stat-change positive">All accounts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Transactions Today</div>
                    <div class="stat-value" id="todayTransactions">0</div>
                    <div class="stat-change positive">+0 vs yesterday</div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Users Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Users</h2>
                        <span class="text-sm text-gray-500" id="userCount">0 users</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Account</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Activity Feed -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Live Activity</h2>
                        <span class="text-sm text-gray-500">Real-time updates</span>
                    </div>
                    <div class="card-body">
                        <div id="activityFeed">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Management Section -->
        <div class="section" id="usersSection">
            <div class="header">
                <h1 class="header-title">User Management</h1>
                <div class="header-actions">
                    <input type="text" class="search-box" id="userSearch" placeholder="Search users by name or email..." onkeyup="searchUsers()">
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">All Users</h2>
                    <span class="text-sm text-gray-500" id="usersCountLabel">0 users</span>
                </div>
                <div class="card-body" style="padding: 0; max-height: 70vh; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Account Type</th>
                                <th>Balance</th>
                                <th>Status</th>
                                <th>Account Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersManagementTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div class="section" id="transactionsSection">
            <div class="header">
                <h1 class="header-title">Transactions</h1>
            </div>
            <div class="card">
                <div class="card-body">
                    <p>Transactions section coming soon...</p>
                </div>
            </div>
        </div>


    </main>



    <!-- User Actions Modal -->
    <div class="modal-overlay" id="userActionModal">
        <div class="modal-content">
            <div class="modal-header">Manage User Account</div>
            <form id="userActionForm">
                <div class="form-group">
                    <label class="form-label">User Name</label>
                    <input type="text" id="userNameDisplay" class="form-input" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">User Email</label>
                    <input type="text" id="userEmailDisplay" class="form-input" readonly>
                </div>

                <div class="form-group">
                    <label class="form-label">Current Balance</label>
                    <input type="text" id="currentBalance" class="form-input" readonly>
                </div>

                <div style="border: 1px solid #E5E7EB; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-label" style="margin-bottom: 1rem;">Account Status Controls</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                        <button type="button" onclick="updateUserStatus(currentEditingUserId, 'freeze')" class="btn btn-warning">‚ùÑÔ∏è Freeze Account</button>
                        <button type="button" onclick="updateUserStatus(currentEditingUserId, 'unfreeze')" class="btn btn-success">‚úì Unfreeze</button>
                        <button type="button" onclick="updateUserStatus(currentEditingUserId, 'block')" class="btn btn-danger">üö´ Block User</button>
                        <button type="button" onclick="updateUserStatus(currentEditingUserId, 'unblock')" class="btn btn-success">‚úì Unblock</button>
                        <button type="button" onclick="updateUserStatus(currentEditingUserId, 'suspend')" class="btn btn-warning">‚è∏Ô∏è Suspend</button>
                        <button type="button" onclick="updateUserStatus(currentEditingUserId, 'unsuspend')" class="btn btn-success">‚úì Resume</button>
                        <button type="button" onclick="updateUserStatus(currentEditingUserId, 'disable')" class="btn btn-danger">üîí Disable</button>
                        <button type="button" onclick="updateUserStatus(currentEditingUserId, 'enable')" class="btn btn-success">‚úì Enable</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Adjust Balance (‚Ç¨)</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="number" id="balanceAmount" class="form-input" placeholder="Enter amount" step="0.01">
                        <button type="button" onclick="adjustBalance(currentEditingUserId, 'add')" class="btn btn-success" style="flex: 0 0 auto;">+ Add</button>
                        <button type="button" onclick="adjustBalance(currentEditingUserId, 'deduct')" class="btn btn-danger" style="flex: 0 0 auto;">- Deduct</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Set New Balance (‚Ç¨)</label>
                    <input type="number" id="balanceSet" class="form-input" placeholder="Enter new balance" step="0.01">
                    <button type="button" onclick="adjustBalance(currentEditingUserId, 'set')" style="width: 100%; margin-top: 0.5rem;" class="btn btn-primary">Set Balance</button>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="closeUserActionModal()">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="bank-core-v2.js"></script>
    <script>
        // Admin credentials (simple check)
        const ADMIN_PASSWORD = 'admin123';
        let currentEditingUserId = null;
        
        // ===== Auto-populate test users if database is empty =====
        function initializeTestUsers() {
            const users = VanstraBank.getAllUsers();
            if (users.length === 0) {
                console.log('Creating test users...');
                // Create test users
                const testUsers = [
                    { fullName: 'John Smith', email: 'john@vanstra.bank', dateOfBirth: '1990-05-15', phone: '+49301234567', password: 'Test1234!', pin: '1234' },
                    { fullName: 'Maria Garcia', email: 'maria@vanstra.bank', dateOfBirth: '1992-08-22', phone: '+49301234568', password: 'Test1234!', pin: '5678' },
                    { fullName: 'Ahmed Hassan', email: 'ahmed@vanstra.bank', dateOfBirth: '1988-03-10', phone: '+49301234569', password: 'Test1234!', pin: '9012' },
                    { fullName: 'Sara Mueller', email: 'sara@vanstra.bank', dateOfBirth: '1995-12-01', phone: '+49301234570', password: 'Test1234!', pin: '3456' },
                    { fullName: 'Carlos Rodriguez', email: 'carlos@vanstra.bank', dateOfBirth: '1987-07-20', phone: '+49301234571', password: 'Test1234!', pin: '7890' }
                ];
                
                testUsers.forEach(userData => {
                    VanstraBank.createAccount(userData);
                });                console.log('‚úì Test users created');
            }
        }
        
        // Call on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTestUsers);
        } else {
            initializeTestUsers();
        }
        
        // Check admin access
        if (!sessionStorage.getItem('adminAuthenticated')) {
            const password = prompt('Enter admin password:');
            if (password !== ADMIN_PASSWORD) {
                alert('Access denied');
                window.location.href = 'login.html';
            } else {
                sessionStorage.setItem('adminAuthenticated', 'true');
            }
        }

        let refreshInterval;
        let syncInterval;
        let adminSyncInterval;
        let allUsers = [];
        let lastSyncTime = new Date();

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Create test users if database is empty
            initializeTestUsers();
            // Slight delay to ensure users are created
            setTimeout(() => {
                initializeAdminHeader();
                loadDashboard();
                loadUsersManagement();
                startRealtimeUpdates();
                startRealtimeSync();
                startAdminRealtimeSync();
                
                // Listen for events
                VanstraBank.on('user_created', () => { loadDashboard(); loadUsersManagement(); saveUsersToStorage(); });
                VanstraBank.on('user_login', () => loadDashboard());
                VanstraBank.on('user_logout', () => loadDashboard());
                VanstraBank.on('transaction', () => loadDashboard());
            }, 100);
        });

        function initializeAdminHeader() {
            // Get admin user from localStorage
            const adminUser = localStorage.getItem('currentSession') ? JSON.parse(localStorage.getItem('currentSession')) : null;
            
            // Get admin info from session or use default
            const adminName = adminUser?.fullName || 'Administrator';
            const adminEmail = adminUser?.email || 'admin@vanstra.bank';
            const loginTime = sessionStorage.getItem('adminLoginTime') || new Date().toLocaleString('de-DE');
            
            // Set admin initials
            const initials = adminName.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('adminInitials').textContent = initials.substring(0, 2);
            
            // Set admin info
            document.getElementById('adminName').textContent = adminName;
            document.getElementById('adminEmail').textContent = adminEmail;
            
            // Format login time
            const now = new Date();
            const loginTimeDate = new Date(loginTime);
            const diffMs = now - loginTimeDate;
            const diffMins = Math.floor(diffMs / 60000);
            
            let timeStr = 'Logged in now';
            if (diffMins > 1) {
                timeStr = `Logged in ${diffMins} minutes ago`;
            } else if (diffMins === 1) {
                timeStr = 'Logged in 1 minute ago';
            }
            
            document.getElementById('adminLoginTime').textContent = timeStr;
            
            // Store login time for future reference
            if (!sessionStorage.getItem('adminLoginTime')) {
                sessionStorage.setItem('adminLoginTime', now.toISOString());
            }
        }

        function showSection(sectionName) {
            // Visual feedback
            console.log('Navigation to section:', sectionName);
            
            // Hide ALL sections
            document.querySelectorAll('.section').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            
            // Show the target section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
                console.log('Section shown: ' + sectionName + 'Section');
            } else {
                console.error('Section not found:', sectionName + 'Section');
                return;
            }
            
            // Update sidebar highlighting (modern nav buttons)
            document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.nav button[data-section="${sectionName}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        function loadDashboard() {
            const users = VanstraBank.getAllUsers();
            allUsers = users;
            
            // Update stats
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('onlineUsers').textContent = users.filter(u => u.isOnline).length;
            document.getElementById('userCount').textContent = users.length + ' users';
            
            const totalBalance = users.reduce((sum, u) => sum + u.balance, 0);
            document.getElementById('totalBalance').textContent = '‚Ç¨' + totalBalance.toLocaleString('de-DE', {minimumFractionDigits: 2});
            
            // Update users table
            const tableBody = document.getElementById('usersTable');
            if (tableBody) {
                tableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${user.fullName.split(' ').map(n => n[0]).join('')}</div>
                                <div class="user-info">
                                    <div class="user-name">${user.fullName}</div>
                                    <div class="user-email">${user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="font-family: monospace; font-size: 13px;">${user.accountNumber}</div>
                            <div style="font-size: 12px; color: #6B7280;">${user.accountType}</div>
                        </td>
                        <td>
                            <strong>‚Ç¨${user.balance.toLocaleString('de-DE', {minimumFractionDigits: 2})}</strong>
                        </td>
                        <td>
                            <span class="online-indicator ${user.isOnline ? 'online' : 'offline'}">
                                <span class="online-dot"></span>
                                ${user.isOnline ? 'Online' : 'Offline'}
                            </span>
                        </td>
                        <td>
                            ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('de-DE', {hour: '2-digit', minute:'2-digit', day:'numeric', month:'short'}) : 'Never'}
                        </td>
                    </tr>
                `).join('');
            }
            
            // Chat user select removed (internal chat disabled)
        }

        function loadUsersManagement() {
            const users = VanstraBank.getAllUsers();
            allUsers = users;
            
            const tableBody = document.getElementById('usersManagementTable');
            const countLabel = document.getElementById('usersCountLabel');
            
            if (countLabel) {
                countLabel.textContent = users.length + ' users';
            }
            
            if (!tableBody) return;
            
            tableBody.innerHTML = users.map(user => {
                const accountStatus = user.accountStatus || 'active';
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${user.fullName.split(' ').map(n => n[0]).join('')}</div>
                                <div class="user-info">
                                    <div class="user-name">${user.fullName}</div>
                                    <div class="user-email">${user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>${user.accountType}</td>
                        <td><strong>‚Ç¨${user.balance.toLocaleString('de-DE', {minimumFractionDigits: 2})}</strong></td>
                        <td>
                            <span class="online-indicator ${user.isOnline ? 'online' : 'offline'}">
                                <span class="online-dot"></span>
                                ${user.isOnline ? 'Online' : 'Offline'}
                            </span>
                        </td>
                        <td>
                            <span class="status-tag ${accountStatus}">
                                ${accountStatus.charAt(0).toUpperCase() + accountStatus.slice(1)}
                            </span>
                        </td>
                        <td>
                            <div class="user-actions">
                                <button class="btn btn-primary" onclick="openUserActionModal('${user.id}', '${user.fullName.replace(/'/g, "\\'")}', '${user.email}', '${user.balance}')">
                                    Manage
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function searchUsers() {
            const searchInput = document.getElementById('userSearch');
            const tableBody = document.getElementById('usersManagementTable');
            
            if (!searchInput || !tableBody) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            
            const filteredUsers = allUsers.filter(user => 
                user.fullName.toLowerCase().includes(searchTerm) || 
                user.email.toLowerCase().includes(searchTerm)
            );
            
            const accountStatus = filteredUsers[0]?.accountStatus || 'active';
            tableBody.innerHTML = filteredUsers.map(user => `
                <tr>
                    <td>
                        <div class="user-cell">
                            <div class="user-avatar">${user.fullName.split(' ').map(n => n[0]).join('')}</div>
                            <div class="user-info">
                                <div class="user-name">${user.fullName}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.accountType}</td>
                    <td><strong>‚Ç¨${user.balance.toLocaleString('de-DE', {minimumFractionDigits: 2})}</strong></td>
                    <td>
                        <span class="online-indicator ${user.isOnline ? 'online' : 'offline'}">
                            <span class="online-dot"></span>
                            ${user.isOnline ? 'Online' : 'Offline'}
                        </span>
                    </td>
                    <td>
                        <span class="status-tag ${accountStatus || 'active'}">
                            ${(user.accountStatus || 'active').charAt(0).toUpperCase() + (user.accountStatus || 'active').slice(1)}
                        </span>
                    </td>
                    <td>
                        <div class="user-actions">
                            <button class="btn btn-primary" onclick="openUserActionModal('${user.id}', '${user.fullName.replace(/'/g, "\\'")}', '${user.email}', '${user.balance}')">
                                Manage
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openUserActionModal(userId, fullName, email, balance) {
            currentEditingUserId = userId;
            document.getElementById('userNameDisplay').value = fullName;
            document.getElementById('userEmailDisplay').value = email;
            document.getElementById('currentBalance').value = '‚Ç¨' + parseFloat(balance).toLocaleString('de-DE', {minimumFractionDigits: 2});
            document.getElementById('balanceAmount').value = '';
            document.getElementById('balanceSet').value = '';
            document.getElementById('userActionModal').classList.add('active');
        }

        function closeUserActionModal() {
            document.getElementById('userActionModal').classList.remove('active');
            currentEditingUserId = null;
        }

        function updateUserStatus(userId, action) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const statusMap = {
                'freeze': 'frozen',
                'unfreeze': 'active',
                'block': 'blocked',
                'unblock': 'active',
                'suspend': 'suspended',
                'unsuspend': 'active',
                'disable': 'disabled',
                'enable': 'active'
            };
            
            const newStatus = statusMap[action];
            user.accountStatus = newStatus;
            
            // Save to localStorage
            const users = VanstraBank.getAllUsers().map(u => 
                u.id === userId ? {...u, accountStatus: newStatus} : u
            );
            localStorage.setItem('users', JSON.stringify(users));
            
            // Immediate sync
            saveUsersToStorage();
            
            // Update UI
            document.getElementById('userActionModal').classList.remove('active');
            loadUsersManagement();
            
            alert(`User account ${action}ed successfully!`);
        }

        function adjustBalance(userId, action) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            let newBalance = user.balance;
            
            if (action === 'add') {
                const amount = parseFloat(document.getElementById('balanceAmount').value);
                if (isNaN(amount) || amount <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }
                newBalance += amount;
            } else if (action === 'deduct') {
                const amount = parseFloat(document.getElementById('balanceAmount').value);
                if (isNaN(amount) || amount <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }
                newBalance -= amount;
            } else if (action === 'set') {
                const amount = parseFloat(document.getElementById('balanceSet').value);
                if (isNaN(amount) || amount < 0) {
                    alert('Please enter a valid balance');
                    return;
                }
                newBalance = amount;
            }
            
            if (newBalance < 0) {
                alert('Balance cannot be negative');
                return;
            }
            
            user.balance = newBalance;
            
            // Save to localStorage
            const users = VanstraBank.getAllUsers().map(u => 
                u.id === userId ? {...u, balance: newBalance} : u
            );
            localStorage.setItem('users', JSON.stringify(users));
            
            // Immediate sync
            saveUsersToStorage();
            
            // Update UI
            document.getElementById('currentBalance').value = '‚Ç¨' + newBalance.toLocaleString('de-DE', {minimumFractionDigits: 2});
            document.getElementById('balanceAmount').value = '';
            document.getElementById('balanceSet').value = '';
            loadUsersManagement();
            
            alert(`Balance ${action}ed successfully!`);
        }

        function startRealtimeUpdates() {
            // Poll for updates every 2 seconds
            refreshInterval = setInterval(() => {
                loadDashboard();
                try {
                    loadActivityFeed();
                } catch (e) {
                    // ignore if activity feed not available
                }
                // Internal chat disabled; no chat updates
            }, 2000);
        }

        function startRealtimeSync() {
            // Auto-save user data every 3 seconds
            syncInterval = setInterval(() => {
                syncUsersToStorage();
            }, 3000);
            
            // Initial sync
            syncUsersToStorage();
        }
        
        function startAdminRealtimeSync() {
            // Poll VanstraBank for live user data every 3 seconds
            clearInterval(adminSyncInterval);
            
            adminSyncInterval = setInterval(() => {
                updateAdminDashboard();
            }, 3000);
            
            // Initial update
            updateAdminDashboard();
        }
        
        function updateAdminDashboard() {
            try {
                const users = VanstraBank.getAllUsers();
                const onlineUsers = users.filter(u => u.isOnline).length;
                const totalBalance = users.reduce((sum, u) => sum + (u.balance || 0), 0);
                const todayTransactions = users.reduce((sum, u) => {
                    const today = new Date().toDateString();
                    return sum + (u.transactions || []).filter(tx => 
                        new Date(tx.timestamp).toDateString() === today
                    ).length;
                }, 0);
                
                // Update stat cards with live data
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('onlineUsers').textContent = onlineUsers;
                document.getElementById('totalBalance').textContent = '‚Ç¨' + totalBalance.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('todayTransactions').textContent = todayTransactions;
                
                // Update user tables with latest data if dashboard is active
                if (document.getElementById('dashboardSection').classList.contains('active')) {
                    loadDashboard();
                }
                
                if (document.getElementById('usersSection').classList.contains('active')) {
                    loadUsersManagement();
                }
                
                // Update sync status with current time
                updateSyncStatus('synced');
                
            } catch (error) {
                console.error('Dashboard update error:', error);
                updateSyncStatus('error');
            }
        }

        function syncUsersToStorage() {
            try {
                const users = VanstraBank.getAllUsers();
                if (users && users.length > 0) {
                    localStorage.setItem('users', JSON.stringify(users));
                    lastSyncTime = new Date();
                    updateSyncStatus('synced');
                    console.log('‚úì Users synced to storage at', lastSyncTime.toLocaleTimeString());
                }
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('error');
            }
        }

        function saveUsersToStorage() {
            // Immediate save on user action
            try {
                const users = VanstraBank.getAllUsers();
                localStorage.setItem('users', JSON.stringify(users));
                lastSyncTime = new Date();
                updateSyncStatus('synced');
                console.log('‚úì Users saved immediately');
            } catch (error) {
                console.error('Save error:', error);
                updateSyncStatus('error');
            }
        }

        function updateSyncStatus(status) {
            const syncElement = document.getElementById('syncStatus');
            const lastSyncElement = document.getElementById('lastSyncTime');
            
            if (!syncElement) return;
            
            if (status === 'syncing') {
                syncElement.classList.add('syncing');
                syncElement.classList.remove('error');
                syncElement.innerHTML = '<span class="sync-dot spinning"></span><span>Syncing...</span>';
            } else if (status === 'synced') {
                syncElement.classList.remove('syncing', 'error');
                const timeStr = lastSyncTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                syncElement.innerHTML = '<span class="sync-dot"></span><span>Synced</span><span id="lastSyncTime" style="font-size: 11px; opacity: 0.8;">' + timeStr + '</span>';
            } else if (status === 'error') {
                syncElement.classList.add('error');
                syncElement.classList.remove('syncing');
                syncElement.innerHTML = '<span class="sync-dot"></span><span>Sync Error</span>';
            }
        }

        function loadActivityFeed() {
            const events = VanstraBank.getAdminEvents().slice(0, 10);
            const feed = document.getElementById('activityFeed');
            
            feed.innerHTML = events.map(event => {
                let iconClass = 'user';
                let text = '';
                
                switch(event.event) {
                    case 'user_created':
                        iconClass = 'user';
                        text = 'New user registered: ' + (event.data.user?.fullName || 'Unknown');
                        break;
                    case 'user_login':
                        iconClass = 'login';
                        text = (event.data.user?.fullName || 'User') + ' logged in';
                        break;
                    case 'user_logout':
                        iconClass = 'logout';
                        text = 'User logged out';
                        break;
                    case 'transaction':
                        iconClass = 'transaction';
                        text = 'Transaction: ' + (event.data.transaction?.description || 'Unknown');
                        break;
                    case 'pin_failed':
                        iconClass = 'pin';
                        text = 'PIN authorization failed';
                        break;
                    default:
                        text = event.event;
                }
                
                const html = '<div class="event-item"><div class="event-icon ' + iconClass + '"><svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">' + getIconForEvent(event.event) + '</svg></div><div class="event-content"><div class="event-text">' + text + '</div><div class="event-time">' + new Date(event.timestamp).toLocaleTimeString('de-DE') + '</div></div></div>';
                return html;
            }).join('');
        }

        function getIconForEvent(event) {
            const icons = {
                user_created: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>',
                user_login: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>',
                user_logout: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>',
                transaction: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
                pin_failed: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>'
            };
            return icons[event] || icons.user_created;
        }

        function addActivityEvent(type, text, userId) {
            // This would add to the feed in real-time
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            localStorage.removeItem('adminSession');
            window.location.href = 'login.html';
        }
    </script>
    
    </body>
</html>